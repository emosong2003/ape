<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Explorateur Entreprises</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input[type="date"] { display: block; margin: 10px 0; padding: 6px; width: 300px; }
    fieldset { margin-bottom: 20px; }
    legend { font-weight: bold; }
    .checkbox-group { display: flex; flex-wrap: wrap; }
    .checkbox-group label { width: 150px; }
    button { padding: 8px 12px; }
    pre { background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <div id="app">
    <h2>Filtrez les entreprises</h2>
    <fieldset>
      <legend>1. Département</legend>
      <select v-model="selectedDep" @change="loadEpcis" :disabled="departements.length===0">
        <option disabled value="">-- Choisir un département --</option>
        <option v-for="dep in departements" :key="dep" :value="dep">{{ dep }}</option>
      </select>
    </fieldset>

    <fieldset v-if="epcis.length">
      <legend>2. EPCI (millésime 2025)</legend>
      <select v-model="selectedEpci" @change="loadCommunes">
        <option disabled value="">-- Choisir un EPCI --</option>
        <option v-for="epci in epcis" :key="epci" :value="epci">{{ epci }}</option>
      </select>
    </fieldset>

    <fieldset v-if="communes.length">
      <legend>3. Codes postaux (choix multiples)</legend>
      <div class="checkbox-group">
        <label v-for="cp in communes" :key="cp">
          <input type="checkbox" :value="cp" v-model="selectedCP" /> {{ cp }}
        </label>
      </div>
    </fieldset>

    <!-- Autres champs du formulaire... -->

    <button @click="buildQuery">Générer requête</button>
    <pre v-if="requete">{{ requete }}</pre>
  </div>

  <script>
    const BASE = 'https://public.opendatasoft.com';
    new Vue({ el: '#app', data: {
        departements: [], epcis: [], communes: [],
        selectedDep:'', selectedEpci:'', selectedCP:[], requete:'' },
      created() {
        // Chargement des départements via facets
        fetch(`${BASE}/api/v2/catalog/datasets/intercommunalites-millesimees/records?refine=millésime:2025&rows=0&facets=dep_name`)
          .then(res=>res.json())
          .then(data => {
            const fg = data.facet_groups.find(g=>g.name==='dep_name');
            this.departements = fg? fg.facets.map(f=>f.name).sort(): [];
          })
          .catch(err => console.error('Erreur chargement départements :', err));
      },
      methods: {
        loadEpcis() {
          this.epcis=[]; this.selectedEpci=''; this.communes=[];
          if(!this.selectedDep) return;
          const dep = encodeURIComponent(this.selectedDep);
          fetch(`${BASE}/api/v2/catalog/datasets/intercommunalites-millesimees/records?refine=millésime:2025&refine=dep_name:${dep}&rows=0&facets=epci_name`)
            .then(res=>res.json())
            .then(data => {
              const fg = data.facet_groups.find(g=>g.name==='epci_name');
              this.epcis = fg? fg.facets.map(f=>f.name).sort(): [];
            })
            .catch(err => console.error('Erreur chargement EPCI :', err));
        },
        loadCommunes() {
          this.communes=[];
          if(!this.selectedEpci) return;
          const epci = encodeURIComponent(this.selectedEpci);
          fetch(`${BASE}/api/v2/catalog/datasets/georef-france-commune/records?refine=epci_name:${epci}&rows=0&facets=code_postal`)  
            .then(res=>res.json())
            .then(data => {
              const fg = data.facet_groups.find(g=>g.name==='code_postal');
              this.communes = fg? fg.facets.map(f=>f.name).sort(): [];
            })
            .catch(err => console.error('Erreur chargement codes postaux :', err));
        },
        buildQuery() {
          const parts = [];
          if(this.selectedDep) parts.push(`dep_name='${this.selectedDep}'`);
          if(this.selectedEpci) parts.push(`epci_name='${this.selectedEpci}'`);
          if(this.selectedCP.length) parts.push(`codepostaletablissement IN ('${this.selectedCP.join("','")}')`);
          this.requete = 'WHERE ' + parts.join(' AND ');
        }
      }
    });
  </script>
</body>
</html>
